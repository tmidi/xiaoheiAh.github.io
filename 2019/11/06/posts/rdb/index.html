<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Redis-RDB持久化 | xiaohei&#39;s blog | Java Developer</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content=noodp><meta name=Description content=赵小黑的各种记录><link rel=prev href=https://xiaohei.im/2019/11/06/posts/db/><link rel=next href=https://xiaohei.im/2019/11/08/posts/aof/><link rel=canonical href=https://xiaohei.im/2019/11/06/posts/rdb/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#da532c><meta name=theme-color content=#ffffff><meta name=twitter:card content=summary><meta name=twitter:title content=Redis-RDB持久化><meta name=twitter:description content="redis 为内存数据库,一旦服务器进程退出,服务器中的数据就不见了.所以内存中的数据需要持久化的硬盘中来保证可以在必要的时候进行故障恢复. RDB 就是 redis 提供的一种持久化方式."><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Redis-RDB持久化","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xiaohei.im\/2019\/11\/06\/posts\/rdb\/"},"image":{"@type":"ImageObject","url":"https:\/\/xiaohei.im\/cover.png","width":800,"height":600},"genre":"posts","keywords":"redis","wordcount":3541,"url":"https:\/\/xiaohei.im\/2019\/11\/06\/posts\/rdb\/","datePublished":"2019-11-06T19:08:56\x2b08:00","dateModified":"2019-11-06T19:08:56\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"XXXX","logo":{"@type":"ImageObject","url":"https:\/\/xiaohei.im\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css integrity="sha256-fdcFNFiBMrNfWL6OcAGQz6jDgNTRxnrLEd4vJYFWScE=" crossorigin=anonymous><link rel=stylesheet href=/css/lib/animate/animate.min.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://xiaohei.im/>xiaohei&#39;s blog | Java Developer</a></div><div class=navbar-menu><a class=menu-item href=https://xiaohei.im/posts/>文章</a>
<a class=menu-item href=https://xiaohei.im/tags/>标签</a>
<a class=menu-item href=https://xiaohei.im/categories/>分类</a>
<a class=menu-item href=https://xiaohei.im/about/>关于</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://xiaohei.im/>xiaohei&#39;s blog | Java Developer</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://xiaohei.im/posts/>文章</a>
<a class=menu-item href=https://xiaohei.im/tags/>标签</a>
<a class=menu-item href=https://xiaohei.im/categories/>分类</a>
<a class=menu-item href=https://xiaohei.im/about/>关于</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><main class=main><div class=container><article class=post-warp><h1 class="post-title animated flipInX">Redis-RDB持久化</h1><div class=post-meta><div class=post-meta-main><a class=author href=https://xiaohei.im/ rel=author><i class="fas fa-user-circle fa-fw"></i>xiaoheiAh&nbsp;</a>
<span class=post-category>收录于
<i class="far fa-folder fa-fw"></i><a href=https://xiaohei.im/categories/redis/>redis</a></span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2019-11-06>2019-11-06</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>约 3541 字&nbsp;
<i class="far fa-clock fa-fw"></i>预计阅读 8 分钟&nbsp;</div></div><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#什么是-rdb>什么是 RDB?</a><ul><li><a href=#如何执行>如何执行?</a></li><li><a href=#如何载入>如何载入?</a></li><li><a href=#bgsave-执行时的状态>BGSAVE 执行时的状态</a></li></ul></li><li><a href=#定时执行bgsave>定时执行BGSAVE</a><ul><li><a href=#快照策略-snapshotting>快照策略 Snapshotting</a><ul><li><a href=#默认的保存条件>默认的保存条件</a></li></ul></li><li><a href=#dirty-计数器-lastsave-属性>dirty 计数器 &amp; lastsave 属性</a></li><li><a href=#定时执行过程>定时执行过程</a><ul><li><a href=#满足条件逻辑>满足条件逻辑</a></li></ul></li></ul></li><li><a href=#rdb-文件结构>RDB 文件结构</a><ul><li><a href=#解析rdb结构>解析RDB结构</a><ul><li><a href=#value-type>value type</a></li><li><a href=#键值编码格式>键值编码格式</a></li></ul></li><li><a href=#length-encoding>Length Encoding</a><ul><li><a href=#如何工作>如何工作?</a></li><li><a href=#编码结果是>编码结果是?</a></li></ul></li><li><a href=#string-encoding>String Encoding</a></li></ul></li><li><a href=#分析rdb文件>分析RDB文件</a><ul><li><a href=#魔数和版本号>魔数和版本号</a></li><li><a href=#辅助字段-aux-fields>辅助字段 Aux Fields</a></li><li><a href=#数据库相关标记>数据库相关标记</a></li><li><a href=#key-value-结构>Key Value 结构</a></li><li><a href=#结束符-校验码>结束符 &amp; 校验码</a></li></ul></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>目录</span><span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#什么是-rdb>什么是 RDB?</a><ul><li><a href=#如何执行>如何执行?</a></li><li><a href=#如何载入>如何载入?</a></li><li><a href=#bgsave-执行时的状态>BGSAVE 执行时的状态</a></li></ul></li><li><a href=#定时执行bgsave>定时执行BGSAVE</a><ul><li><a href=#快照策略-snapshotting>快照策略 Snapshotting</a><ul><li><a href=#默认的保存条件>默认的保存条件</a></li></ul></li><li><a href=#dirty-计数器-lastsave-属性>dirty 计数器 &amp; lastsave 属性</a></li><li><a href=#定时执行过程>定时执行过程</a><ul><li><a href=#满足条件逻辑>满足条件逻辑</a></li></ul></li></ul></li><li><a href=#rdb-文件结构>RDB 文件结构</a><ul><li><a href=#解析rdb结构>解析RDB结构</a><ul><li><a href=#value-type>value type</a></li><li><a href=#键值编码格式>键值编码格式</a></li></ul></li><li><a href=#length-encoding>Length Encoding</a><ul><li><a href=#如何工作>如何工作?</a></li><li><a href=#编码结果是>编码结果是?</a></li></ul></li><li><a href=#string-encoding>String Encoding</a></li></ul></li><li><a href=#分析rdb文件>分析RDB文件</a><ul><li><a href=#魔数和版本号>魔数和版本号</a></li><li><a href=#辅助字段-aux-fields>辅助字段 Aux Fields</a></li><li><a href=#数据库相关标记>数据库相关标记</a></li><li><a href=#key-value-结构>Key Value 结构</a></li><li><a href=#结束符-校验码>结束符 &amp; 校验码</a></li></ul></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p><code>redis</code> 为内存数据库,一旦服务器进程退出,服务器中的数据就不见了.所以内存中的数据需要持久化的硬盘中来保证可以在必要的时候进行故障恢复. <code>RDB</code> 就是 <code>redis</code> 提供的一种持久化方式.</p><blockquote><p>官方关于持久化的文章: <a href=https://redis.io/topics/persistence>https://redis.io/topics/persistence</a></p></blockquote><a class=post-dummy-target id=什么是-rdb></a><h2>什么是 RDB?</h2><p><code>RDB</code> 是 <code>redis</code> 提供的一种持久化方式,可以手动执行,也可以通过定时任务定期执行,可以将某个时间节点的数据库状态保存到一个 <code>RDB</code> 文件中,叫做 <code>dump.rdb</code>.如果开启了压缩算法( <code>LZF</code> )的支持,则可以利用算法减少文件大小.服务器意外宕机或者断电后重启都可以通过该文件来恢复数据库状态.</p><a class=post-dummy-target id=如何执行></a><h3>如何执行?</h3><p>有两个命令可以生成 <code>RDB</code> 文件.</p><ol><li><strong>SAVE:</strong> 执行时进程阻塞,无法处理其他命令</li><li><strong>BGSAVE:</strong> 新建一个子进程来后台生成 <code>RDB</code> 文件</li></ol><p>具体实现逻辑在: <code>src/rdb.c/rdbSave()</code>,从官方文档可知,该实现是基于 <code>cow</code> 的.</p><blockquote><p><a href=https://redis.io/topics/persistence>https://redis.io/topics/persistence</a></p><p>This method allows Redis to benefit from copy-on-write semantics.</p></blockquote><a class=post-dummy-target id=如何载入></a><h3>如何载入?</h3><p><code>RDB</code> 文件会在 <code>redis</code> 启动时自动载入.</p><p>由于 <code>AOF</code> 持久化的实时性更好,所以如果同时开启了 <code>AOF</code> , <code>RDB</code> 两种持久化,会优先使用 <code>AOF</code> 来恢复.</p><a class=post-dummy-target id=bgsave-执行时的状态></a><h3>BGSAVE 执行时的状态</h3><p><code>BGSAVE</code> 执行期间会拒绝 <code>SAVE/BGSAVE</code> 的命令,避免产生 <code>竞争条件</code>.</p><p><code>BGSAVE</code> 执行期间 <code>BGREWRITEAOF</code> 命令会延迟到 <code>BGSAVE</code> 执行完之后执行.</p><p><code>BGREWRITEAOF</code> 在执行时, <code>BGSAVE</code> 命令会被拒绝.</p><p><code>BGSAVE</code> 和 <code>BGREWRITEAOF</code> 命令的权衡完全是性能方面的考虑.毕竟都会有大量的磁盘写入,影响性能.</p><a class=post-dummy-target id=定时执行bgsave></a><h2>定时执行BGSAVE</h2><p><code>BGSAVE</code> 不会阻塞服务器进程,所以 <code>redis</code> 允许用户通过配置, 定时执行 <code>BGSAVE</code> 命令.</p><a class=post-dummy-target id=快照策略-snapshotting></a><h3>快照策略 Snapshotting</h3><p>可以通过设置 N 秒内至少 M 次修改来触发一次 <code>BGSAVE</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>save <span class=m>60</span> <span class=m>1000</span> <span class=c1># 60s内有至少1000次修改时 bgsave 一次</span></code></pre></td></tr></table></div></div><a class=post-dummy-target id=默认的保存条件></a><h4>默认的保存条件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>save <span class=m>900</span> <span class=m>1</span>
save <span class=m>300</span> <span class=m>10</span>
save <span class=m>60</span> <span class=m>10000</span></code></pre></td></tr></table></div></div><a class=post-dummy-target id=dirty-计数器-lastsave-属性></a><h3>dirty 计数器 &amp; lastsave 属性</h3><p><code>redis</code> 中维护了一个计数器,来记录距离上一次 <code>SAVE/BGSAVE</code> 后服务器对所有数据库进行了多少次增删改,叫做 <code>dirty计数器</code>.属于 <code>redisServer</code> 结构体的属性之一.</p><p><code>lastsave</code> 是记录了上一次成功执行 <code>SAVE/BGSAVE</code> 的 <code>UNIX时间戳</code> , 同样是 <code>redisServer</code> 结构体的属性之一.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp># src/server.h
</span><span class=cp></span><span class=k>struct</span> <span class=n>redisServer</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=kt>long</span> <span class=kt>long</span> <span class=n>dirty</span><span class=p>;</span> <span class=cm>/* Changes to DB from the last save */</span>
  <span class=n>time_t</span> <span class=n>lastsave</span><span class=p>;</span> <span class=cm>/* Unix time of last successful save */</span>
  <span class=p>...</span>
<span class=p>}</span></code></pre></td></tr></table></div></div><a class=post-dummy-target id=定时执行过程></a><h3>定时执行过程</h3><p><code>redis</code> 有一个定时任务 <code>serverCron</code> , 每隔 <code>100ms</code> 就会执行一次,用于维护服务器.该任务就会检查 <code>save</code> 设置的保存条件是否满足,满足则执行 <code>BGSAVE</code></p><a class=post-dummy-target id=满足条件逻辑></a><h4>满足条件逻辑</h4><p>遍历设置的 <code>save</code> 参数, 计算当前时间到 <code>lastsave</code> 的间隔 <code>interval</code> , 如果 <code>dirty</code> &gt; <code>save.change</code> &amp; <code>interval</code> &gt; <code>save.seconds</code> 那么就执行保存</p><a class=post-dummy-target id=rdb-文件结构></a><h2>RDB 文件结构</h2><blockquote><p><a href=https://github.com/sripathikrishnan/redis-rdb-tools/wiki/Redis-RDB-Dump-File-Format>https://github.com/sripathikrishnan/redis-rdb-tools/wiki/Redis-RDB-Dump-File-Format</a></p><p>写下这篇文章时参考版本为 2019.09.05 更新的版本</p></blockquote><p><code>RDB</code> 文件格式对读写进行了很多优化,这类优化导致其格式与内存中存在的形式极其相似,同时利用 <code>LZF</code> 压缩算法来优化文件的大小.一般来讲, <code>redis</code> 对象都会提前标记自身的大小,所以备份<code>RDB</code> 在读取这些 <code>object</code> 时,可以提前知道要分配多少内存.</p><a class=post-dummy-target id=解析rdb结构></a><h3>解析RDB结构</h3><p>下面的代码展示的是 16 进制下 <code>RDB</code> 文件的结构,便于理解</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>----------------------------# RDB is a binary format. There are no new lines or spaces in the file.
<span class=m>52</span> <span class=m>45</span> <span class=m>44</span> <span class=m>49</span> <span class=m>53</span>              <span class=c1># 魔数 REDIS的16进制表示,代表这是个RDB文件</span>
<span class=m>30</span> <span class=m>30</span> <span class=m>30</span> <span class=m>37</span>                 <span class=c1># 4位ascii码表示当前RDB版本号,这里表示&#34;0007&#34; = 7</span>
----------------------------
FE <span class=m>00</span>                       <span class=c1># FE 表明这是数据库选择标记. 00 表示选中0号数据库</span>
----------------------------# Key-Value pair starts
FD <span class=nv>$unsigned</span> int            <span class=c1># FD 是秒级过期时间的标记. 紧接着是 4 byte unsigned int 过期时间</span>
<span class=nv>$value</span>-type                 <span class=c1># 1 byte 标记 value 类型 - set, map, sorted set etc.</span>
<span class=nv>$string</span>-encoded-key         <span class=c1># 经过编码后的键</span>
<span class=nv>$encoded</span>-value              <span class=c1># 值,编码格式取决去 $value-type</span>
----------------------------
FC <span class=nv>$unsigned</span> long           <span class=c1># FC 表明是毫秒级过期时间. 过期时间值是 8 bytes的 unsigned long,是一个unit时间戳</span>
<span class=nv>$value</span>-type                 <span class=c1># 同上秒级时间</span>
<span class=nv>$string</span>-encoded-key         <span class=c1># 同上秒级时间</span>
<span class=nv>$encoded</span>-value              <span class=c1># 同上秒级时间</span>
----------------------------
<span class=nv>$value</span>-type                 <span class=c1># 这一栏是没有过期时间的key-value</span>
<span class=nv>$string</span>-encoded-key
<span class=nv>$encoded</span>-value
----------------------------
FE <span class=nv>$length</span>-encoding         <span class=c1># 前一个数据库的编码完成,选择新的数据库进行处理.数据库编号会根据 length-encoding 格式获得</span>
----------------------------
...                         <span class=c1># Key value pairs for this database, additonal database</span>
                            
FF                          <span class=c1>## 表明 RDB 文件结束了</span> 
<span class=m>8</span> byte checksum             <span class=c1>## 8byte CRC 64 校验码</span></code></pre></td></tr></table></div></div><a class=post-dummy-target id=value-type></a><h4>value type</h4><p>1 byte 表示了 <code>value</code> 的类型.</p><table><thead><tr><th>type(以下为十进制表示)</th><th>编码类型</th></tr></thead><tbody><tr><td>0</td><td>String</td></tr><tr><td>1</td><td>List</td></tr><tr><td>2</td><td>Set</td></tr><tr><td>3</td><td>Sorted Set</td></tr><tr><td>4</td><td>Hash</td></tr><tr><td>9</td><td>Zipmap</td></tr><tr><td>10</td><td>Ziplist</td></tr><tr><td>11</td><td>Intset</td></tr><tr><td>12</td><td>Sorted Set in Ziplist</td></tr><tr><td>13</td><td>HashMap in Ziplist</td></tr></tbody></table><a class=post-dummy-target id=键值编码格式></a><h4>键值编码格式</h4><p>键(<code>key</code>)都是字符串,所以使用<code>string</code> 编码格式.</p><p>值(<code>value</code>)就会有不同的区分:</p><ul><li>如果 <code>value type</code> 为 0 ,会是简单的字符串.</li><li>如果 <code>value type</code> 为 9,10,11,12, 值会被包装为 <code>string</code>, 在读到该字符串后,会进一步解析.</li><li>如果 <code>value type</code> 为 1,2,3,4, 值会是一个字符串数组.</li></ul><a class=post-dummy-target id=length-encoding></a><h3>Length Encoding</h3><p>长度编码是用来存储对象的长度的.是一种可变字节码,旨在使用尽可能少的字节.</p><a class=post-dummy-target id=如何工作></a><h4>如何工作?</h4><ol><li>从流中读取 1byte,得到高两位.</li><li>如果是 <code>00</code> 开头, 那么剩下 6 位表示长度</li><li>如果是 <code>01</code> 开头, 会再从流中读取 1byte,合起来总共 14 位作为长度.</li><li>如果是 <code>10</code> 开头, 会直接丢弃剩下的 6 位.再从流中读取 4bytes作为长度.</li><li>如果是 <code>11</code> 开头, 说明这个对象是一种特殊编码格式. 剩下的 6 位表示了它的格式类型.这个编码通常用来将数字存储为字符串,或者存储被编码过得字符串(<a href=#String-Encoding>String Encoding</a>).</li></ol><a class=post-dummy-target id=编码结果是></a><h4>编码结果是?</h4><p>从上述可得,可能的编码格式是这样的:</p><ol><li>1 byte 最多存储到 63</li><li>2 bytes 最多存储到 16383</li><li>5 bytes 最多存储到 2^32 - 1</li></ol><a class=post-dummy-target id=string-encoding></a><h3>String Encoding</h3><p><code>redis</code> 的字符串是二进制安全的,所以可以存储 anything. 没有任何字符串结尾的标记.最好将 <code>redis</code> 字符串视为一个字节数组.</p><p>有三种类型的字符串:</p><ol><li>长度编码字符串</li></ol><p>这是最简单的一种,字符串的长度会利用 <code>Length Encoding</code> 编码作为前缀,后面跟着字符串的编码</p><ol><li>数字作为字符串</li></ol><p>这里就将上面 <a href=#Length-Encoding>Length Encoding</a> 的特殊编码格式联系起来了,数字作为字符串时以 <code>11</code> 开头,剩下的 6 位表示不同的数字类型</p><ul><li>0 表示接下来是一个 8 位数字</li><li>1 表示接下来是一个 16 位数字</li><li>2 表示接下来是一个 32 位数字</li></ul><ol><li>压缩字符串</li></ol><p>压缩字符串的 <code>Length Encoding</code> 还是以 <code>11</code> 开头的, 但是剩下的6 位二进制的值为 4, 表明后面读取到的是一个压缩字符串.压缩字符串会存储压缩前和压缩后的长度.解析规则如下:</p><ul><li>根据 <code>Length Encoding</code> 读取压缩的长度 <code>clen</code></li><li>根据 <code>Length Encoding</code> 读取未压缩的长度</li><li>从流中读取 <code>clen</code> bytes 的数据</li><li>利用 <code>LZF</code> 算法进行解析</li></ul><a class=post-dummy-target id=分析rdb文件></a><h2>分析RDB文件</h2><p>利用 <code>od</code> 命令来分析来看看 <code>rdb</code> 文件长什么样子.我将 <code>redis</code> 数据库清空后,执行了 <code>set msg hello</code>,所以现在只有一个键 <code>msg</code>, 值为 <code>hello</code>.下面的命令第一行输出的是 16 进制,下面一行输出的是对应的 <code>ascii</code>. 下面进行解析~</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>➜ od -A x -t x1c -v dump.rdb
<span class=m>0000000</span>    <span class=m>52</span>  <span class=m>45</span>  <span class=m>44</span>  <span class=m>49</span>  <span class=m>53</span>  <span class=m>30</span>  <span class=m>30</span>  <span class=m>30</span>  <span class=m>39</span>  fa  <span class=m>09</span>  <span class=m>72</span>  <span class=m>65</span>  <span class=m>64</span>  <span class=m>69</span>  <span class=m>73</span>
           R   E   D   I   S   <span class=m>0</span>   <span class=m>0</span>   <span class=m>0</span>   <span class=m>9</span> <span class=m>372</span>  <span class=se>\t</span>   r   e   d   i   s
<span class=m>0000010</span>    2d  <span class=m>76</span>  <span class=m>65</span>  <span class=m>72</span>  <span class=m>05</span>  <span class=m>35</span>  2e  <span class=m>30</span>  2e  <span class=m>34</span>  fa  0a  <span class=m>72</span>  <span class=m>65</span>  <span class=m>64</span>  <span class=m>69</span>
           -   v   e   r <span class=m>005</span>   <span class=m>5</span>   .   <span class=m>0</span>   .   <span class=m>4</span> <span class=m>372</span>  <span class=se>\n</span>   r   e   d   i
<span class=m>0000020</span>    <span class=m>73</span>  2d  <span class=m>62</span>  <span class=m>69</span>  <span class=m>74</span>  <span class=m>73</span>  c0  <span class=m>40</span>  fa  <span class=m>05</span>  <span class=m>63</span>  <span class=m>74</span>  <span class=m>69</span>  6d  <span class=m>65</span>  c2
           s   -   b   i   t   s <span class=m>300</span>   @ <span class=m>372</span> <span class=m>005</span>   c   t   i   m   e <span class=m>051</span>
<span class=m>0000030</span>    <span class=m>29</span>  e8  c3  5d  fa  <span class=m>08</span>  <span class=m>75</span>  <span class=m>73</span>  <span class=m>65</span>  <span class=m>64</span>  2d  6d  <span class=m>65</span>  6d  c2  d0
           <span class=o>)</span> <span class=m>350</span> <span class=m>303</span>   <span class=o>]</span> <span class=m>372</span>  <span class=se>\b</span>   u   s   e   d   -   m   e   m <span class=m>302</span> <span class=m>007</span>
<span class=m>0000040</span>    <span class=m>07</span>  <span class=m>10</span>  <span class=m>00</span>  fa  0c  <span class=m>61</span>  6f  <span class=m>66</span>  2d  <span class=m>70</span>  <span class=m>72</span>  <span class=m>65</span>  <span class=m>61</span>  6d  <span class=m>62</span>  6c
          <span class=se>\a</span> <span class=m>020</span>  <span class=se>\0</span> <span class=m>372</span>  <span class=se>\f</span>   a   o   f   -   p   r   e   a   m   b   l
<span class=m>0000050</span>    <span class=m>65</span>  c0  <span class=m>00</span>  fe  <span class=m>00</span>  fb  <span class=m>01</span>  <span class=m>00</span>  <span class=m>00</span>  <span class=m>03</span>  6d  <span class=m>73</span>  <span class=m>67</span>  <span class=m>05</span>  <span class=m>68</span>  <span class=m>65</span>
           e <span class=m>300</span>  <span class=se>\0</span> <span class=m>376</span>  <span class=se>\0</span> <span class=m>373</span> <span class=m>001</span>  <span class=se>\0</span>  <span class=se>\0</span> <span class=m>003</span>   m   s   g <span class=m>005</span>   h   e
<span class=m>0000060</span>    6c  6c  6f  ff  <span class=nb>fc</span>  0e  6b  <span class=m>79</span>  fe  <span class=m>47</span>  1a  <span class=m>36</span>
           l   l   o <span class=m>377</span> <span class=m>374</span> <span class=m>016</span>   k   y <span class=m>376</span>   G <span class=m>032</span>   <span class=m>6</span>
000006c</code></pre></td></tr></table></div></div><a class=post-dummy-target id=魔数和版本号></a><h3>魔数和版本号</h3><p>前 5 个字节就是我们看到的 <code>REDIS</code>,以及后四个字节对应的版本号<code>9</code></p><a class=post-dummy-target id=辅助字段-aux-fields></a><h3>辅助字段 Aux Fields</h3><p>这是 <code>Version 7</code> 之后加入的字段, <code>Redis设计与实现</code> 所使用的版本是没有这个,所以一开始有点懵~ 只能看代码了.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp># src/rdb.c
</span><span class=cp></span><span class=cm>/* 该函数负责执行 RDB 文件的写入 */</span>
<span class=kt>int</span> <span class=nf>rdbSave</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=n>rdbSaveInfo</span> <span class=o>*</span><span class=n>rsi</span><span class=p>)</span> <span class=p>{</span>
	<span class=c1>//伪代码
</span><span class=c1></span>  <span class=mf>1.</span> <span class=err>创建一个临时文件</span> <span class=n>temp</span><span class=o>-</span><span class=err>$</span><span class=n>pid</span><span class=p>.</span><span class=n>rdb</span><span class=p>,</span><span class=err>并处理创建失败的逻辑</span>
  <span class=mf>2.</span> <span class=err>新建一个</span><span class=n>redis封装的I</span><span class=o>/</span><span class=n>O流</span>
  <span class=mf>3.</span> <span class=err>写入</span><span class=n>rdb文件</span> <span class=n>rdbSaveRio</span><span class=p>()</span>
  <span class=mf>4.</span> <span class=err>将文件重命名</span><span class=p>,</span> <span class=err>默认重命名为</span> <span class=n>dump</span><span class=p>.</span><span class=n>rdb</span>
  <span class=mf>5.</span> <span class=err>更新服务器的一些状态</span><span class=o>:</span> <span class=n>dirty计数器置0</span><span class=p>,</span><span class=err>更新</span><span class=n>lastsave等</span>
<span class=p>}</span></code></pre></td></tr></table></div></div><p>然后我们来看下写入的 <code>Aux Fields</code>, 在函数 <code>rdbSaveRio</code> 中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>rdbSaveRio</span><span class=p>(</span><span class=n>rio</span> <span class=o>*</span><span class=n>rdb</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>error</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>rdbSaveInfo</span> <span class=o>*</span><span class=n>rsi</span><span class=p>)</span> <span class=p>{</span>
	 <span class=c1>// 忽略所有只看重点
</span><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=n>server</span><span class=p>.</span><span class=n>rdb_checksum</span><span class=p>)</span>
        <span class=n>rdb</span><span class=o>-&gt;</span><span class=n>update_cksum</span> <span class=o>=</span> <span class=n>rioGenericUpdateChecksum</span><span class=p>;</span> <span class=c1>// 生成校验码
</span><span class=c1></span>    <span class=n>snprintf</span><span class=p>(</span><span class=n>magic</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>magic</span><span class=p>),</span><span class=s>&#34;REDIS%04d&#34;</span><span class=p>,</span><span class=n>RDB_VERSION</span><span class=p>);</span> <span class=c1>// 生成魔数及版本号
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>rdbWriteRaw</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=n>magic</span><span class=p>,</span><span class=mi>9</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>goto</span> <span class=n>werr</span><span class=p>;</span> <span class=c1>// 写入魔数及版本号
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveInfoAuxFields</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=n>flags</span><span class=p>,</span><span class=n>rsi</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>goto</span> <span class=n>werr</span><span class=p>;</span> <span class=c1>// 写入 AuxFileds
</span><span class=c1></span><span class=p>}</span>

<span class=cm>/* Save a few default AUX fields with information about the RDB generated. */</span>
<span class=kt>int</span> <span class=nf>rdbSaveInfoAuxFields</span><span class=p>(</span><span class=n>rio</span> <span class=o>*</span><span class=n>rdb</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>rdbSaveInfo</span> <span class=o>*</span><span class=n>rsi</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>redis_bits</span> <span class=o>=</span> <span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span> <span class=o>==</span> <span class=mi>8</span><span class=p>)</span> <span class=o>?</span> <span class=mi>64</span> <span class=o>:</span> <span class=mi>32</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>aof_preamble</span> <span class=o>=</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>RDB_SAVE_AOF_PREAMBLE</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=cm>/* Add a few fields about the state when the RDB was created. */</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrStr</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;redis-ver&#34;</span><span class=p>,</span><span class=n>REDIS_VERSION</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;redis-bits&#34;</span><span class=p>,</span><span class=n>redis_bits</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;ctime&#34;</span><span class=p>,</span><span class=n>time</span><span class=p>(</span><span class=nb>NULL</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;used-mem&#34;</span><span class=p>,</span><span class=n>zmalloc_used_memory</span><span class=p>())</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>

    <span class=cm>/* Handle saving options that generate aux fields. */</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rsi</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;repl-stream-db&#34;</span><span class=p>,</span><span class=n>rsi</span><span class=o>-&gt;</span><span class=n>repl_stream_db</span><span class=p>)</span>
            <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrStr</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;repl-id&#34;</span><span class=p>,</span><span class=n>server</span><span class=p>.</span><span class=n>replid</span><span class=p>)</span>
            <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;repl-offset&#34;</span><span class=p>,</span><span class=n>server</span><span class=p>.</span><span class=n>master_repl_offset</span><span class=p>)</span>
            <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rdbSaveAuxFieldStrInt</span><span class=p>(</span><span class=n>rdb</span><span class=p>,</span><span class=s>&#34;aof-preamble&#34;</span><span class=p>,</span><span class=n>aof_preamble</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
<span class=p>}</span></code></pre></td></tr></table></div></div><p>以上可以看出会写入这些字段.</p><ul><li><p><code>redis-ver</code>：版本号</p></li><li><p><code>redis-bits</code>：OS 操作系统位数 <sup>32</sup>&frasl;<sub>64</sub></p></li><li><p><code>ctime</code>：RDB文件创建时间</p></li><li><p><code>used-mem</code>：使用内存大小</p></li><li><p><code>repl-stream-db</code>：在server.master客户端中选择的数据库</p></li><li><p><code>repl-id</code>：当前实例 replication ID</p></li><li><p><code>repl-offset</code>：当前实例复制的偏移量</p></li></ul><p>每一个属性写入前都会写入 <code>0XFA</code>, 标记这是一个辅助字段.在上面命令行输出中,<code>ascii</code> 展示为 <code>372</code></p><a class=post-dummy-target id=数据库相关标记></a><h3>数据库相关标记</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=m>0000050</span>    <span class=m>65</span>  c0  <span class=m>00</span>  fe  <span class=m>00</span>  fb  <span class=m>01</span>  <span class=m>00</span>  <span class=m>00</span>  <span class=m>03</span>  6d  <span class=m>73</span>  <span class=m>67</span>  <span class=m>05</span>  <span class=m>68</span>  <span class=m>65</span>
           e <span class=m>300</span>  <span class=se>\0</span> <span class=m>376</span>  <span class=se>\0</span> <span class=m>373</span> <span class=m>001</span>  <span class=se>\0</span>  <span class=se>\0</span> <span class=m>003</span>   m   s   g <span class=m>005</span>   h   e</code></pre></td></tr></table></div></div><p>这一行中的 <code>0XFE</code> 表示选择数据库,后面紧接着 <code>00</code> 即为,选择 0 号数据库. <code>0XFB</code> 是标记了当前数据库中键存储的数量,这里用到了 <code>Length Encoding</code>, <code>01</code> 是我们存储的字典中<code>key-value</code>的数量,<code>00</code> 是过期字典(<code>expires</code>)中的数量.</p><blockquote><p>redisDB中有两个属性, <code>dict</code> 记录了我们写入的所有键, <code>expires</code> 存储了我们设置有过期时间的键以及其过期时间.</p></blockquote><a class=post-dummy-target id=key-value-结构></a><h3>Key Value 结构</h3><p>我们设置了 <code>msg</code> -&gt; <code>hello</code>,在输出中是这样的.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=m>0000050</span>    <span class=m>65</span>  c0  <span class=m>00</span>  fe  <span class=m>00</span>  fb  <span class=m>01</span>  <span class=m>00</span>  <span class=m>00</span>  <span class=m>03</span>  6d  <span class=m>73</span>  <span class=m>67</span>  <span class=m>05</span>  <span class=m>68</span>  <span class=m>65</span>
           e <span class=m>300</span>  <span class=se>\0</span> <span class=m>376</span>  <span class=se>\0</span> <span class=m>373</span> <span class=m>001</span>  <span class=se>\0</span>  <span class=se>\0</span> <span class=m>003</span>   m   s   g <span class=m>005</span>   h   e</code></pre></td></tr></table></div></div><p>在 <code>msg</code> 前面的字段 <code>\0 003</code>, 表示他是 <code>string</code> 类型, 且长度为 <code>3</code>, <code>005 hello</code>, 表示是长度为 <code>5</code> 的 <code>hello</code>.</p><p>还有其他数据结构这里就不做展示了.</p><a class=post-dummy-target id=结束符-校验码></a><h3>结束符 &amp; 校验码</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=m>0000060</span>    6c  6c  6f  ff  <span class=nb>fc</span>  0e  6b  <span class=m>79</span>  fe  <span class=m>47</span>  1a  <span class=m>36</span>
           l   l   o <span class=m>377</span> <span class=m>374</span> <span class=m>016</span>   k   y <span class=m>376</span>   G <span class=m>032</span>   <span class=m>6</span></code></pre></td></tr></table></div></div><p>最后一行输出中 <code>0xff</code> , 文件结束符, 剩下的八个字节就是 <code>CRC64</code></p><a class=post-dummy-target id=参考></a><h2>参考</h2><ol><li><p><a href=https://cloud.tencent.com/developer/article/1179710>https://cloud.tencent.com/developer/article/1179710</a></p></li><li><p><a href=https://juejin.im/post/5d8dc285f265da5b9e0d3089>Redis5.0 RDB文件解析</a></p></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>本文于 2019-11-06 更新</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=https://xiaohei.im/2019/11/06/posts/rdb/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://xiaohei.im/tags/redis/><i class="fas fa-tag fa-fw"></i>redis</a></span></section><section><span><a href=javascript:window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=https://xiaohei.im/>主页</a></span></section></div><div class=post-nav><a href=https://xiaohei.im/2019/11/06/posts/db/ class=prev rel=prev title=Redis-数据库长什么样?><i class="fas fa-angle-left fa-fw"></i>Redis-数据库长什么样?</a>
<a href=https://xiaohei.im/2019/11/08/posts/aof/ class=next rel=next title=Redis-AOF持久化>Redis-AOF持久化<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script type=text/javascript>var gitalk=new Gitalk({id:"2019-11-06 19:08:56 \x2b0800 \x2b0800",title:"Redis-RDB持久化",clientID:"e38fc798c72a7e4e1386",clientSecret:"e151aa3b7b98d3cfaa1f096b88fdd7897e2c8007",repo:"xiaoheiAh.github.io",owner:"xiaoheiAh",admin:["xiaoheiAh"],body:decodeURI(location.href)});gitalk.render("gitalk-container");</script><noscript>Please enable JavaScript to view the <a href=https://github.com/gitalk/gitalk>comments powered by gitalk.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2019</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://xiaohei.im/>xiaoheiAh</a></span><span class=license>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-98254666-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>